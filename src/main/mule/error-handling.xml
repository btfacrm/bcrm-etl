<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:email="http://www.mulesoft.org/schema/mule/email"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/email http://www.mulesoft.org/schema/mule/email/current/mule-email.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">

	<error-handler name="Error_Handler_global">
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="34cb6096-4dbf-4ff1-85a9-092c2e5c8771" type="ANY">
				<logger level="INFO" doc:name="Logger" doc:id="14c1d09a-d45b-424d-95c0-2a304438037d" message="------------------------Error---------------------"/>
				<ee:transform doc:name="Transform Message" doc:id="52036ca6-580d-45be-89eb-7b3757e0e265" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
							output application/json
							---
							{
								"correlationId": correlationId,
								"error-message" : error.detailedDescription default "Internal error",
								"timestamp" : now()	
							}]]></ee:set-payload>
					</ee:message>
				<ee:variables >
					<ee:set-variable variableName="MailSubject" ><![CDATA['Data Sync Application Fail Alert']]></ee:set-variable>
				</ee:variables>
				</ee:transform>
				<flow-ref doc:name="generate_EmailAlert" doc:id="2f2e6e15-405c-4020-9bbf-72b0312ef5ba" name="generate_EmailAlert"/>
			</on-error-propagate>
	</error-handler>
	<sub-flow name="generate_EmailAlert" doc:id="c62d7857-d607-497a-8d9e-7bd9211a5477" >
		<logger level="INFO" doc:name="Logger" doc:id="62694222-fde3-4068-bd67-880d15258e87" message="---------------------------Send email--------------"/>
		<email:send doc:name="Send" doc:id="f6fec465-a546-480c-9efc-61bb060063cd" config-ref="emailSMTP" fromAddress="${emailSMTP.fromAddress}" subject="#[vars.MailSubject]">
			<email:to-addresses >
				<email:to-address value="${emailSMTP.toAddress}" />
			</email:to-addresses>
			<email:body contentType="text/plain">
			</email:body>
			<email:attachments ><![CDATA[#[vars.FailedRecords]]]></email:attachments>
		</email:send>
	</sub-flow>

</mule>
